{% extends 'base.html' %}

{% block head %}


{% endblock %}

{% block bodyt %}
<div class="content">
    <div class="container py-4">

        <!-- HEADER -->
        <div class="gallery-header text-center">
            <p>
                Zdjƒôcia od fotografa to nie wszystko ‚Äî podziel siƒô zdjƒôciem siebie i najbli≈ºszych!<br>
                Podpisz zdjƒôcie, aby≈õmy mogli siƒô lepiej poznaƒá üòä
            </p>
            <div class="d-flex flex-column flex-sm-row justify-content-center gap-3 mt-2">
                <button class="btn btn-upload" data-bs-toggle="modal" data-bs-target="#uploadModal">
                    üì§ Wgraj zdjƒôcie
                </button>

                <button class="btn btn-download" id="downloadAllBtn">
                    üì• Pobierz wszystkie
                </button>
            </div>
        </div>
        <hr>

        <!-- Upload Modal -->
        <div class="modal fade" id="uploadModal" tabindex="-1" aria-labelledby="uploadModalLabel">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content rounded-4 border-0 shadow">
                    <div class="modal-header border-0">
                        <h3 class="modal-title fw-semibold" id="uploadModalLabel">Dodaj nowe zdjƒôcie</h3>

                    </div>
                    <div class="modal-body">
                        <form id="uploadForm" enctype="multipart/form-data" method="post" action="/gallery/upload">
                            <div class="mb-3">
                                <label for="photoInput" class="form-label">Wybierz zdjƒôcie</label>
                                <br>
                                <label for="photoInput" class="form-label"
                                    style="font-size: 11pt; font-style: italic;">(Wybierz maksymalnie
                                    5 zdjƒôƒá.)</label>
                                <input class="form-control" type="file" name="photoInput" accept="image/*" maxlength="2"
                                    required multiple>
                                <div id="fileNumberError" class="text-danger mt-2" style="display:none;"></div>
                            </div>
                            <div class="mb-3">
                                <label for="captionInput" class="form-label">Podpis (imiona lub opis)</label>
                                <input type="text" class="form-control" name="captionInput"
                                    placeholder="Np. Dagmara i Maciek">
                            </div>

                            <div class="modal-footer border-0">
                                <input type="submit" class="btn btn-upload rounded-pill" id="savePhotoBtn"
                                    value="Prze≈õlij">
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal" id="downloadModal" tabindex="-1" aria-labelledby="downloadModalLabel">

        </div>

        <!-- ‚ö†Ô∏è 429 ERROR MODAL -->
        <div class="modal fade" id="error429Modal" tabindex="-1" aria-labelledby="error429Label" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content" style="border-radius: 15px;">
                    <div class="modal-header" style="border-bottom: none;">
                        <h5 class="modal-title" id="error429Label">Zbyt wiele zapyta≈Ñ üò•</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>

                    <div class="modal-body text-center">
                        <p style="font-size: 1.1rem; color: #555;">
                            WyglƒÖda na to, ≈ºe wysy≈Çasz zbyt wiele zapyta≈Ñ naraz.<br>
                            Spr√≥buj ponownie po godzinie:
                        </p>

                        <p id="rateLimitInfo"></p>

                    </div>

                    <div class="modal-footer" style="border-top: none; justify-content: center;">
                        <button class="btn btn-upload" data-bs-dismiss="modal">
                            OK, rozumiem
                        </button>
                    </div>
                </div>
            </div>
        </div>





        <!-- GALLERY -->
        <h2 class="text-center mb-4">Wasze zdjƒôcia</h2>
        <div class="gallery-grid">
            {% for photo in photos %}
            <div class="gallery-card">
                <img src="{{ photo.image_path }}" alt="{{ photo.image_name }}"
                    onclick="openModal('{{ photo.image_path }}')" />
                <div class="gallery-caption">{{ photo.image_caption }}</div>
            </div>
            {% endfor %}
        </div>

        <!-- Image Modal -->
        <div id="imageModal" class="image-modal" onclick="closeModal()">
            <span class="image-modal-close">&times;</span>
            <img class="image-modal-content" id="modalImage">
        </div>

    </div>
</div>

<script>
    function openModal(src) {
        document.getElementById("modalImage").src = src;
        document.getElementById("imageModal").style.display = "block";
    }

    function closeModal() {
        document.getElementById("imageModal").style.display = "none";
    }
</script>

<script>
    document.getElementById("downloadAllBtn").addEventListener("click", async () => {
        const btn = document.getElementById("downloadAllBtn");
        btn.disabled = true;
        btn.innerText = "‚è≥ Przygotowywanie...";

        try {
            const response = await fetch("/gallery/download_all");
            if (!response.ok) {
                const data = await response.json();
                console.log(data.reset_at);
                document.getElementById("rateLimitInfo").textContent = data.reset_at;

                const errorModal = new bootstrap.Modal(document.getElementById('error429Modal'));
                errorModal.show();
                throw new Error("B≈ÇƒÖd podczas pobierania");
            }

            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "guests_gallery.zip";
            document.body.appendChild(a);
            a.click();
            a.remove();
            window.URL.revokeObjectURL(url);
        } catch (err) {
            console.error(err);
        } finally {
            btn.disabled = false;
            btn.innerText = "üì• Pobierz wszystkie";
        }
    });


    document.getElementById("uploadForm").addEventListener("submit", async function (e) {
        e.preventDefault();
        const formData = new FormData(this);

        const response = await fetch("/gallery/upload", {
            method: "POST",
            body: formData
        });

        if (!response.ok) {
            const data = await response.json();
            document.getElementById("fileNumberError").style.display = "block";
            document.getElementById("fileNumberError").innerText = data.error;
        } else {
            location.reload();
        }
    });

</script>
{% endblock %}